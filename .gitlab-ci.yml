image: carlosalgms/composer-and-node-ci

before_script:
  - curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
  - chmod +x wp-cli.phar
  - php wp-cli.phar package install wp-cli/dist-archive-command --allow-root

cache:
  paths:
    - build/
    - vendor/

stages:
  - test
  - build
  - deploy

lint-job:
  stage: test
  script:
    - echo "Linting plugin...."
    - composer install
    - composer run lint:gitlab

test-job:
  stage: test
  script:
    - npm install
    - npm run wp-env start
    - npm run test:unit

build-job:
  stage: build
  script:
    - echo "Building plugin..."
    - composer run build-production
  artifacts:
    reports:
      codequality: phpcs-quality-report.json

deploy-job:
  stage: deploy
  environment: production
  artifacts:
    paths:
      - kudos-donations.zip
  script:
    - echo "Deploying application..."
    - composer run make-zip
    - echo "Application successfully built."
