name: PHP Composer

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  PHP_VERSION: '7.4'
  NODE_VERSION: '18.18.1'
  MARIADB_INITDB_SKIP_TZINFO: 1
  MYSQL_DATABASE: wordpress_test
  MYSQL_HOST: mysql
  MYSQL_USER: wordpress
  MYSQL_PASSWORD: wordpress
  MYSQL_ROOT_PASSWORD: password

jobs:
  validate-composer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up PHP with Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer
      - name: Validate Composer configuration
        run: composer --no-ansi validate

  lint-php:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up PHP with Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer
      - name: Install Composer dependencies
        run: composer install --no-ansi --no-interaction --no-progress --prefer-dist
      - name: Run PHP linting
        run: composer run lint:gitlab

  lint-js-css:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install dependencies
        run: npm ci
      - name: Lint JavaScript and CSS
        run: |
          npm run lint:js
          npm run lint:css

  build-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up PHP with Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install dependencies
        run: |
          npm ci
          composer install --no-ansi --no-interaction --no-progress --prefer-dist
      - name: Build front-end assets
        run: npm run build

  # test-job:
  #   runs-on: ubuntu-latest
  #   services:
  #     mysql:
  #       image: mariadb:latest
  #       ports:
  #         - '3306:3306'
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3
      
  #     - name: Set up PHP
  #       uses: shivammathur/setup-php@v2
  #       with:
  #         php-version: ${{ env.PHP_VERSION }}
      
  #     - name: Install PHP Dependencies
  #       uses: ramsey/composer-install@v3
        
  #     - name: Set up WordPress and WordPress Test Library
  #       uses: sjinks/setup-wordpress-test-library@master
  #       with:
  #         version: latest
          
  #     - name: Run tests
  #       run: vendor/bin/phpunit

  # zip-job:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3
  #     - name: Set up PHP with Composer
  #       uses: shivammathur/setup-php@v2
  #       with:
  #         php-version: ${{ env.PHP_VERSION }}
  #         tools: composer
  #     - name: Install dependencies
  #       run: composer install --optimize-autoloader --no-dev
  #     - name: Create zip archive
  #       run: |
  #         curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
  #         chmod +x wp-cli.phar
  #         php wp-cli.phar package install wp-cli/dist-archive-command --allow-root
  #         composer run make-zip
  #     - name: Upload artifact
  #       uses: actions/upload-artifact@v3
  #       with:
  #         name: kudos-donations.zip
  #         path: kudos-donations.zip

  # release-job:
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3
  #     - name: Create GitHub release
  #       uses: softprops/action-gh-release@v1
  #       with:
  #         files: kudos-donations.zip
